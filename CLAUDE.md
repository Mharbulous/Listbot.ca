<!-- âš™ï¸ Auto-generated by cursor2claude -->

## ðŸŽ¯ Auto-Select Rules (File-Specific)
@.cursor/rules/typescript.mdc <!-- Applies to: **/*.ts, **/*.tsx -->

<!-- DO NOT EDIT ABOVE THIS LINE -->

# CLAUDE.md - Bookkeeper App

This file provides high-level directives for working on the Bookkeeper repository.
This file is **lean by design**. Detailed documentation is in the `/docs` directory.

## 1. CRITICAL: Core Directives

**You MUST follow these rules at all times.**

1.  **AGENT: Linting:** You MUST delegate all linting and code beautification to the `beautifier` agent.
    - _Example_: "Task: Use the `beautifier` agent to fix linting in `src/views/FileUpload.vue`."
2.  **DEV STAGE: Early (No Legacy)**
    - Development is in a pre-alpha stage.
    - **There is NO existing user data.**
    - You MUST NOT write migration scripts.
    - You MUST implement schema changes or refactors _directly_.
    - Firestore and Storage can be wiped clean at any time. Focus on the _optimal_ architecture, not backward compatibility.
3.  **TERMINOLOGY:** The file processing lifecycle has very specific terminology (Original, Source, Upload, Batesed, etc.). You MUST consult `@docs/architecture/file-lifecycle.md` to ensure you use this terminology correctly in all code, comments, and UI text.
4.  **DEDUPLICATION TERMINOLOGY:** File deduplication uses precise terminology that you MUST follow:
    - **"duplicate"** or **"duplicates"**: Files with identical content (hash value) and core metadata (name, size, modified date) where folder path variations have no informational value.  Duplicates are not uploaded and their metadata is not copied.
    - **"redundant"**: Hash-verified duplicates awaiting removal. Files transition from "duplicate" status to "redundant" after hash verification confirms identical content. Redundant files are removed during Stage 1 pre-filter of the next batch, creating a two-phase cleanup lifecycle.
    - **"copy"** or **"copies"**: Files with the same hash value but different file metadata that IS meaningful.  Copies are not uploaded to storage, but their metadata is recorded for informational value.
    - **"best"** or **"primary"**: The file with the most meaningful metadata that will be uploaded to storage their metadata recorded for informational value.
    - **"file metadata"**: Filesystem metadata (name, size, modified date, path) that does not affect hash value    
5.  **TESTS:** All Vitest unit/component tests MUST be located in the `/tests` folder.

---

## 2. Project Overview & Tech Stack

- **Project**: **Bookkeeper** - A Vue 3 bookkeeping app with file upload/processing.
- **Architecture**: Part of a multi-app SSO architecture sharing Firebase Auth.
- **Frontend**: Vue 3 (Composition API)
- **Build Tool**: Vite
- **UI Framework**: Vuetify 3
- **State Management**: Pinia
- **Routing**: Vue Router 4 (hash-based)
- **Backend**: Firebase (Auth, Firestore, Storage)
- **Styling**: Tailwind CSS
- **Testing**: Vitest

---

## 3. Essential Commands

### Standard Dev Server

- **Run server at**: `http://localhost:5173/`

### Multi-App SSO Testing (Use these for auth work)

- `npm run dev:intranet` (intranet.localhost:3000)
- `npm run dev:bookkeeping` (bookkeeping.localhost:3001)
- `npm run dev:files` (files.localhost:3002)

### Pre-Commit (Do NOT run unless requested)

1.  `npm run lint` (Or delegate to `beautifier` agent)
2.  `npm run test:run`
3.  `npm run build`

---

## 4. Documentation & Architecture (@-Imports)

This `CLAUDE.md` is lean. You MUST reference the files below using `@path/to/file` when you need detailed context on architecture or implementation.

- `@docs/architecture/overview.md`
  - High-level component architecture (Layouts, Views, Base vs. Feature).
  - High-level data flow patterns.
- `@docs/architecture/authentication.md`
  - **CRITICAL**: The full "Auth State Machine" logic (`uninitialized` -> `initializing` -> ...).
  - **CRITICAL**: The "Solo Firm" architecture (`firmId === userId`).
  - Route guards and Pinia store integration.
- `@docs/architecture/file-lifecycle.md`
  - **CRITICAL**: The definitive guide to all file terminology (Original, Source, Upload, Batesed, Page, Redacted, Production, Storage).
  - **You MUST use this exact terminology.**
- `@docs/architecture/file-processing.md`
  - The 3-phase hardware-calibrated time estimation formulas.
  - Deduplication strategy (size-pre-filter, BLAKE3 hash as ID).
  - Path parsing optimization logic.
  - Hardware performance calibration (H-Factor system).
- `@src/dev-demos/README.md`
  - Overview of the demo system, routes (`/dev/*`), and components.
- `@docs/testing/performance-analysis.md`
  - Instructions for performance data collection (`parse_console_log.py`).
  - Details on the H-Factor (Hardware Calibration) system.
- `@docs/front-end/DocumentTable.md`
  - DocumentTable architecture and the 4 column data sources (Built-in, System, Firm, Matter categories).
- `@docs/2025-11-10-New-Upload-Page.md`
  - **NEW UPLOAD PAGE**: Development plan for the new upload page at `/testing` route.
  - Both old (`/upload`) and new (`/testing`) pages will coexist during development.
  - **For any coding tasks on the new upload page, consult this document.**

---

## 5. Key Implementation Concepts (High-Level)

This is a brief overview of core concepts. For details, see the `@docs` above.

- **Auth State Machine**: Always check `authStore.isInitialized` before `authStore.isAuthenticated`. The system uses an explicit state machine to prevent Firebase race conditions.
- **"Solo Firm" Architecture**: All data is scoped by a `firmId`. For solo users, the `firmId` is **always** equal to the `userId`. This is a fundamental data model rule.
- **Web Worker Hashing**: File hashing (BLAKE3) is CPU-intensive and MUST run in a web worker (`@/workers/fileHashWorker.js`) to avoid blocking the UI.
- **Hash-Based Deduplication**: Files are deduplicated.
  1.  Files with unique sizes _skip_ hashing.
  2.  Only files with matching sizes are hashed.
  3.  The final BLAKE3 hash is used as the document ID in Firestore, providing automatic, database-level deduplication.
- **Multi-App SSO**: All apps (Bookkeeper, Intranet, Files) share a **single, identical Firebase project config** to enable seamless SSO.

---

## 6. Troubleshooting: File Editing Issues

### Problem: Edit Tool "String to replace not found" Errors

**Symptom**: The `Edit` tool fails with "String to replace not found in file" even though you can see the exact text when reading the file.

**Root Cause**: Character encoding mismatch - the file contains characters (especially emojis like âœ…, ðŸ¤–, etc.) that display the same but have different byte encodings.

### How to Identify This Issue

1. **Use `cat -A` to reveal hidden characters**:
   ```bash
   cat "path/to/file.md" | sed -n '100,110p' | cat -A
   ```

   **What you'll see**:
   - Display shows: `- âœ… **Item**: Description`
   - `cat -A` shows: `- ^E **Item**: Description`

   The `^E` (or other control characters) reveals the actual byte encoding is different from the checkmark emoji you're trying to match.

2. **Check specific line numbers**:
   ```bash
   sed -n '750,752p' "path/to/file.md" | cat -A
   ```

### How to Fix It

**Solution 1: Use `sed` with line number targeting** (Recommended)
```bash
# Replace entire line at specific line number
sed -i '750s/.*/- âœ… **UX4**: New content here/' "path/to/file.md"

# Insert new line after line 750
sed -i '750a- âœ… **UX5**: Additional content' "path/to/file.md"
```

**Why this works**: Targets the line number instead of trying to match the encoded characters.

**Solution 2: Rewrite the entire file section**
If multiple lines need updating, use the `Write` tool to rewrite the entire file with consistent encoding.

**Solution 3: Remove problematic characters**
If emojis aren't essential, use plain text:
```markdown
- [x] **UX4**: Description
```

### Prevention

- **Be consistent with emojis**: If using emojis in markdown, stick to one method (Edit tool or `sed`)
- **Test first**: When editing files with emojis, try a small edit first to verify encoding compatibility
- **Use line numbers**: When you know the exact line to change, prefer `sed` with line numbers over string matching

### Path Format Notes

- **Windows with Git Bash**: Use forward slashes with drive letter: `C:/Users/name/file.md`
- **Relative paths**: `./planning/file.md` (from project root)
- **Absolute paths preferred** for reliability in Windows environments
- DO NOT modify any files from the production branch!  Explanation is provided here:  docs\hosting\2025-11-16-Promotion.md