name: Claude Night Shift (Prioritized Autonomous Agent)

on:
  schedule:
    # Runs at minute 0 and 30, hours 8-13 UTC (Midnight-6am PST/PDT).
    - cron: '0,30 8-13 * * *'
  workflow_dispatch:

# Ensures runs do not overlap.
concurrency: 
  group: claude-night-shift
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  autonomous-agent:
    runs-on: ubuntu-latest
    env:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      # --- DECISION ENGINE (Filtered and Sorted) ---
      - name: Determine Task Priority
        id: decision
        run: |
          # 1. CHECK PRIORITY 1 (RESUME STALLED): Filter by status only, oldest first.
          RESUME_ID=$(gh issue list \
            --label "status: in-progress" \
            --limit 1 \
            --json number \
            --jq '.[0].number')
          
          if [ ! -z "$RESUME_ID" ]; then
            echo "mode=resume" >> $GITHUB_OUTPUT
            echo "issue_id=$RESUME_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Priority 1: Resuming stalled issue #$RESUME_ID (Oldest first)."
            gh issue comment "$RESUME_ID" --body "ü§ñ **Resuming Task:** Workflow detected a previous stalled state and is attempting to finish this issue."
            exit 0
          fi

          # 2. CHECK PRIORITY 2 (NEW WORK): Filter by status only, oldest first.
          NEW_ID=$(gh issue list \
            --label "status: ready-for-ai" \
            --limit 1 \
            --json number \
            --jq '.[0].number')
          
          if [ ! -z "$NEW_ID" ]; then
            echo "mode=new" >> $GITHUB_OUTPUT
            echo "issue_id=$NEW_ID" >> $GITHUB_OUTPUT
            
            # Lock the issue immediately
            gh issue edit "$NEW_ID" \
              --remove-label "status: ready-for-ai" \
              --add-label "status: in-progress"
            
            gh issue comment "$NEW_ID" \
              --body "ü§ñ Claude is starting work on this task (Priority 2)."
            
            echo "‚úÖ Priority 2: Starting new issue #$NEW_ID (Oldest first)."
            exit 0
          fi

          # 3. PRIORITY 3 (MAINTENANCE MODE)
          echo "mode=maintenance" >> $GITHUB_OUTPUT
          echo "‚úÖ Priority 3: No issues found. Entering maintenance mode."

      # --- EXECUTION: ISSUE MODE (Resume or New) ---
      - name: Work on Issue
        id: run_issue
        if: steps.decision.outputs.mode == 'resume' || steps.decision.outputs.mode == 'new'
        continue-on-error: true
        run: |
          ISSUE_NUMBER=${{ steps.decision.outputs.issue_id }}
          echo "Working on Issue #$ISSUE_NUMBER..."

          # Fetch the full issue content (title, body, comments)
          ISSUE_CONTENT=$(gh issue view "$ISSUE_NUMBER" --json title,body,comments --jq '{title: .title, body: .body, comments: [.comments[].body]}')

          # Validate that we successfully fetched the issue
          if [ -z "$ISSUE_CONTENT" ] || [ "$ISSUE_CONTENT" = "{}" ]; then
            echo "‚ùå Error: Failed to fetch issue #$ISSUE_NUMBER content"
            gh issue comment "$ISSUE_NUMBER" --body "‚ö†Ô∏è **Fetch Error:** Claude could not retrieve the issue content. Please check the issue format and try again."
            exit 1
          fi

          # Extract title and body for the prompt
          ISSUE_TITLE=$(echo "$ISSUE_CONTENT" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_CONTENT" | jq -r '.body // "No description provided"')

          echo "üìã Issue Title: $ISSUE_TITLE"
          echo "üìù Processing issue content..."

          # Construct the prompt for Claude
          # TODO: Consider verifying PR was created by checking recent PRs or parsing Claude output
          CLAUDE_PROMPT="Please process GitHub issue #$ISSUE_NUMBER.

          ISSUE TITLE: $ISSUE_TITLE

          ISSUE DESCRIPTION: $ISSUE_BODY

          TASK INSTRUCTIONS:
          1. Analyze the requirements described in the issue
          2. Implement the requested changes following the project's coding standards
          3. Run any necessary tests to verify your changes
          4. Create a Pull Request with:
             - A clear title referencing issue #$ISSUE_NUMBER
             - A description of what was changed and why
             - Link to issue #$ISSUE_NUMBER using 'Closes #$ISSUE_NUMBER' or 'Fixes #$ISSUE_NUMBER'

          Remember: You are working in the ListBot.ca repository. Follow all guidelines in CLAUDE.md and the @docs folder."

          # Pass the prompt to Claude
          claude -p "$CLAUDE_PROMPT"

      # --- EXECUTION: MAINTENANCE MODE CASCADE ---
      - name: Run Maintenance Cascade
        id: run_maintenance
        if: steps.decision.outputs.mode == 'maintenance'
        continue-on-error: true
        run: |
          echo "‚öôÔ∏è Entering Maintenance Mode..."
          echo "‚ÑπÔ∏è  Maintenance tasks are currently disabled. See TODO comments below."

          # TODO: Implement P3a - Documentation Streamlining
          # Purpose: Review docs/ folder for inconsistencies, outdated content, broken links
          # Suggested prompt: "Review all files in the docs/ folder for consistency with the codebase.
          #                   Check for outdated information, broken cross-references, and missing documentation.
          #                   If changes are needed, create a PR titled 'Nightly Maintenance: Doc Streamline'."
          # echo "-> Running doc streamline..."
          # claude -p "Review all files in docs/ for consistency..." || true

          # TODO: Implement P3b - Documentation Reconciliation
          # Purpose: Ensure CLAUDE.md and sub-docs match actual codebase structure and conventions
          # Suggested prompt: "Reconcile documentation in CLAUDE.md and @docs with the actual codebase.
          #                   Verify that documented patterns match implementation, update any discrepancies.
          #                   If changes are needed, create a PR titled 'Nightly Maintenance: Doc Reconcile'."
          # echo "-> Running doc reconcile..."
          # claude -p "Reconcile CLAUDE.md and @docs with codebase..." || true

          # TODO: Implement P3c - General Code Streamlining
          # Purpose: Identify and fix code quality issues (unused imports, console.logs, etc.)
          # Suggested prompt: "Review codebase for quality improvements: remove unused imports,
          #                   debug console.logs, fix obvious linting issues, simplify overly complex functions.
          #                   If changes are made, create a PR titled 'Nightly Maintenance: Code Streamline'."
          # echo "-> Running code streamline..."
          # claude -p "Review codebase for quality improvements..." || true

          echo "‚úÖ Maintenance mode complete (no active tasks)."

      # --- POST-PROCESSING: SUCCESS (Issues Only) ---
      - name: Mark Issue Complete
        if: (steps.decision.outputs.mode == 'resume' || steps.decision.outputs.mode == 'new') && steps.run_issue.outcome == 'success'
        run: |
          ISSUE_NUMBER=${{ steps.decision.outputs.issue_id }}
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "status: in-progress" \
            --add-label "status: ai-complete"
          
          gh issue comment "$ISSUE_NUMBER" \
            --body "‚úÖ Task completed successfully. A Pull Request should be linked to this issue."

      # --- POST-PROCESSING: FAILURE (Issues Only) ---
      - name: Mark Issue Error
        if: (steps.decision.outputs.mode == 'resume' || steps.decision.outputs.mode == 'new') && steps.run_issue.outcome == 'failure'
        run: |
          ISSUE_NUMBER=${{ steps.decision.outputs.issue_id }}
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "status: in-progress" \
            --add-label "status: ai-error"
          
          gh issue comment "$ISSUE_NUMBER" \
            --body "‚ö†Ô∏è **Claude Error:** The AI agent failed to complete the task (Exit Code 1). Check Action logs for details (likely out of credits, API timeout, or unresolvable code issue)."