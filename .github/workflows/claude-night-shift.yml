name: Claude Night Shift (Prioritized Autonomous Agent)

on:
  schedule:
    # Runs at minute 0 and 30, hours 8-13 UTC (Midnight-6am PST/PDT).
    - cron: '0,30 8-13 * * *'
  workflow_dispatch:

# Ensures runs do not overlap.
concurrency: 
  group: claude-night-shift
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  autonomous-agent:
    runs-on: ubuntu-latest
    env:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      # --- DECISION ENGINE (Filtered and Sorted) ---
      - name: Determine Task Priority
        id: decision
        run: |
          # Define bot user for filtering
          BOT_USER="matthew-manuel"

          # 1. CHECK PRIORITY 1 (RESUME STALLED): Filter by status AND assignee, sort oldest first.
          RESUME_ID=$(gh issue list \
            --label "status: in-progress" \
            --assignee "$BOT_USER" \
            --order asc \
            --limit 1 \
            --json number \
            --jq '.[0].number')
          
          if [ ! -z "$RESUME_ID" ]; then
            echo "mode=resume" >> $GITHUB_OUTPUT
            echo "issue_id=$RESUME_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Priority 1: Resuming stalled issue #$RESUME_ID (Oldest first)."
            gh issue comment "$RESUME_ID" --body "ü§ñ **Resuming Task:** Workflow detected a previous stalled state and is attempting to finish this issue."
            exit 0
          fi

          # 2. CHECK PRIORITY 2 (NEW WORK): Filter by status AND assignee, sort oldest first.
          NEW_ID=$(gh issue list \
            --label "status: ready-for-ai" \
            --assignee "$BOT_USER" \
            --order asc \
            --limit 1 \
            --json number \
            --jq '.[0].number')
          
          if [ ! -z "$NEW_ID" ]; then
            echo "mode=new" >> $GITHUB_OUTPUT
            echo "issue_id=$NEW_ID" >> $GITHUB_OUTPUT
            
            # Lock the issue immediately
            gh issue edit "$NEW_ID" \
              --remove-label "status: ready-for-ai" \
              --add-label "status: in-progress" \
              --comment "ü§ñ Claude is starting work on this task (Priority 2)."
            
            echo "‚úÖ Priority 2: Starting new issue #$NEW_ID (Oldest first)."
            exit 0
          fi

          # 3. PRIORITY 3 (MAINTENANCE MODE)
          echo "mode=maintenance" >> $GITHUB_OUTPUT
          echo "‚úÖ Priority 3: No issues found. Entering maintenance mode."

      # --- EXECUTION: ISSUE MODE (Resume or New) ---
      - name: Work on Issue
        id: run_issue
        if: steps.decision.outputs.mode == 'resume' || steps.decision.outputs.mode == 'new'
        continue-on-error: true
        run: |
          ISSUE_NUMBER=${{ steps.decision.outputs.issue_id }}
          echo "Working on Issue #$ISSUE_NUMBER..."
          
          claude -p "Please process issue #$ISSUE_NUMBER. 
          1. Analyze the requirements.
          2. Implement the fix.
          3. Create a Pull Request with the changes."

      # --- EXECUTION: MAINTENANCE MODE CASCADE ---
      - name: Run Maintenance Cascade
        id: run_maintenance
        if: steps.decision.outputs.mode == 'maintenance'
        continue-on-error: true 
        run: |
          echo "Running documentation and code maintenance cascade..."
          
          # P3a: Run Doc Streamline
          echo "-> Running /doc-streamline..."
          claude -p "/doc-streamline. If any changes are made, create a PR titled 'Nightly Maintenance: Doc Streamline'." || true
          
          # P3b: Run Doc Reconcile
          echo "-> Running /doc-reconcile..."
          claude -p "/doc-reconcile. If any changes are made, create a separate PR titled 'Nightly Maintenance: Doc Reconcile'." || true

          # P3c: Run General Streamline
          echo "-> Running /streamline..."
          claude -p "/streamline. If any changes are made, create a separate PR titled 'Nightly Maintenance: General Streamlining'." || true
          
          echo "Maintenance cascade complete."

      # --- POST-PROCESSING: SUCCESS (Issues Only) ---
      - name: Mark Issue Complete
        if: (steps.decision.outputs.mode == 'resume' || steps.decision.outputs.mode == 'new') && steps.run_issue.outcome == 'success'
        run: |
          ISSUE_NUMBER=${{ steps.decision.outputs.issue_id }}
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "status: in-progress" \
            --add-label "status: ai-complete" \
            --comment "‚úÖ Task completed successfully. A Pull Request should be linked to this issue."

      # --- POST-PROCESSING: FAILURE (Issues Only) ---
      - name: Mark Issue Error
        if: (steps.decision.outputs.mode == 'resume' || steps.decision.outputs.mode == 'new') && steps.run_issue.outcome == 'failure'
        run: |
          ISSUE_NUMBER=${{ steps.decision.outputs.issue_id }}
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "status: in-progress" \
            --add-label "status: ai-error" \
            --comment "‚ö†Ô∏è **Claude Error:** The AI agent failed to complete the task (Exit Code 1). Check Action logs for details (likely out of credits, API timeout, or unresolvable code issue)."