# Phase 1.5: Firebase AI Setup & Troubleshooting

**Status:** ‚úÖ Resolved
**Date Started:** 2025-11-07
**Date Resolved:** 2025-11-09
**Last Updated:** 2025-11-09
**Related Phase:** Phase 2 - AI Document Analysis

---

## Overview

This document tracks the setup and troubleshooting of Firebase AI Logic (Vertex AI in Firebase) integration for AI-powered metadata extraction in the Bookkeeper app.

---

## Problem Statement

After implementing Phase 2 AI document analysis, users encountered **403 Forbidden** errors when attempting to use the AI analysis features. The error message indicated that the Firebase AI API was not enabled, despite the API being enabled in the Firebase Console.

### Initial Error

```
POST https://firebasevertexai.googleapis.com/v1beta/projects/coryphaeus-ed11a/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent 403 (Forbidden)

FirebaseError: AI: The Firebase AI SDK requires the Firebase AI API ('firebasevertexai.googleapis.com') to be enabled in your Firebase project.
```

---

## Investigation & Solutions Attempted

### ‚úÖ Solution 1: Verified Firebase AI API is Enabled

**Action Taken:**
- Checked Firebase Console at: https://console.firebase.google.com/project/coryphaeus-ed11a/genai/
- Verified "Get Started" button was already clicked
- Confirmed API is enabled in Google Cloud Console

**Result:**
- API was already enabled
- This was NOT the root cause

---

### ‚úÖ Solution 2: Verified Billing Configuration

**Action Taken:**
- Confirmed project is on Blaze (pay-as-you-go) plan
- Verified billing account is linked

**Result:**
- Billing is properly configured
- This was NOT the root cause

---

### ‚úÖ Solution 3: Fixed Backend Type (ROOT CAUSE FOUND)

**Problem Identified:**
The code was using `VertexAIBackend`, which is designed for **server-side Node.js applications** and requires:
- Google Cloud IAM service account credentials
- Server-side authentication
- Additional permissions configuration

The Bookkeeper app is a **client-side web application** and needs the default backend.

**Action Taken:**
Changed `src/services/firebase.js` from:
```javascript
import { getAI, VertexAIBackend } from 'firebase/ai';
// ...
firebaseAI = getAI(app, { backend: new VertexAIBackend() });
```

To:
```javascript
import { getAI } from 'firebase/ai';
// ...
firebaseAI = getAI(app); // Uses default backend for client-side apps
```

**Result:**
- Code change committed: `c64076a`
- ‚úÖ **CONFIRMED WORKING** - See "Resolution Confirmed" section below

---

### ‚úÖ Solution 4: Improved Error Handling

**Action Taken:**
Enhanced `DocumentMetadataPanel.vue` to provide user-friendly error messages:

**Features Added:**
- `aiError` reactive state for tracking errors
- Error detection and categorization:
  - API not enabled
  - File too large
  - Unknown/general errors
- User-friendly error alert UI with:
  - Clear error titles and messages
  - Actionable next steps
  - Direct links to Firebase Console
  - Dismissable alerts

**Result:**
- Code change committed: `4d3de98`
- Users now see helpful error messages instead of just console errors
- Provides clear guidance for resolving configuration issues

---

### ‚úÖ Solution 5: Code Quality Improvements

**Action Taken:**
Added defensive programming improvements based on code review:

**Changes:**
- Added optional chaining (`?.`) to all error property accesses
- Added fallback values for error messages in UI
- Added clear TODO comment for Phase 3 to replace mock results with real data
- Prevents crashes when error objects have unexpected shape

**Result:**
- Code change committed: `81dead2`
- Error handling is now more robust
- Phase 3 work is clearly documented

---

## Problems Eliminated (Not the Cause)

1. ‚ùå Firebase AI API not enabled ‚Üí API was already enabled
2. ‚ùå Billing not configured ‚Üí Blaze plan active with billing linked
3. ‚ùå API propagation delay ‚Üí API has been enabled for days/weeks
4. ‚ùå Missing environment variables ‚Üí All Firebase env vars are set correctly

---

## Resolution Confirmed ‚úÖ

**Test Date:** 2025-11-09
**Test File:** `2016-12-06 CHQ#282 West Coast re INV#P343345 ($123.05).pdf`
**File Size:** 493.74 KB
**File Type:** PDF

### Test Results

**Status:** ‚úÖ SUCCESS - All tests passed

**API Call:**
- ‚úÖ No 403 errors
- ‚úÖ Gemini API responded successfully
- ‚úÖ Processing time: 3.525 seconds

**AI Analysis Results:**
- **Document Date:** 2016-12-06 (99% confidence)
  - Reasoning: "The date is clearly printed in the format YYYY-MM-DD on the document."
  - Context: "DATE 20 16-12-06"

- **Document Type:** Cheque (95% confidence)
  - Reasoning: "The document has the characteristic layout of a cheque, including fields for payee, amount in numbers and words, bank name and address, and signature."
  - Alternative: Invoice (75% confidence) - noted reference to "RE INU# P343345"

### Console Output (Verification)

```
ü§ñ Starting Gemini AI analysis...
File: 2016-12-06 CHQ#282 West Coast re INV#P343345 ($123.05).pdf
Extension: pdf
Size: 493.74 KB
üì§ Sending request to Gemini API...
üì• Received response from Gemini API
‚úÖ Analysis completed in 3525ms
```

**Conclusion:** The backend fix (switching from VertexAIBackend to default backend) successfully resolved the 403 Forbidden errors. Firebase AI Logic is now fully operational.

---

## Final Status

### All Tasks Completed ‚úÖ
- [x] Identified root cause: Wrong backend type (VertexAIBackend vs default)
- [x] Fixed Firebase AI initialization to use default backend
- [x] Added comprehensive error handling and user feedback
- [x] Added defensive error checks and code quality improvements
- [x] Committed and pushed all changes to branch `claude/fix-console-errors-011CUv6mYej11mSReXGDp3Xp`
- [x] Created troubleshooting documentation
- [x] Restarted dev server to pick up changes
- [x] Tested AI analysis with "Analyze Document" button
- [x] Verified 403 errors are resolved
- [x] Confirmed Gemini API calls succeed
- [x] Tested with PDF file type

---

## Technical Details

### Backend Types in Firebase AI SDK

**VertexAIBackend** (Server-side)
- For Node.js server applications
- Requires service account credentials
- Needs Google Cloud IAM permissions
- Direct access to Vertex AI API

**Default Backend** (Client-side)
- For web applications running in browser
- Uses Firebase authentication automatically
- Works with Firebase API keys
- No additional IAM setup required

### Files Modified

1. **src/services/firebase.js**
   - Removed `VertexAIBackend` import and usage
   - Changed to default backend: `getAI(app)`
   - Updated comments to clarify backend usage

2. **src/components/document/tabs/AIAnalysisTab.vue**
   - Added `aiError` state tracking
   - Enhanced `handleAnalyzeClick` with error detection
   - Added error alert UI component
   - Added CSS styling for error display

---

## Troubleshooting Reference (For Future Issues)

If similar issues arise in the future, check these potential causes:

1. **API Key Restrictions**
   - Go to: https://console.cloud.google.com/apis/credentials?project=coryphaeus-ed11a
   - Verify no restrictions are blocking `firebasevertexai.googleapis.com`

2. **User Authentication**
   - Ensure user is properly authenticated in Firebase Auth
   - Check `authStore.isAuthenticated` and `authStore.currentFirm`

3. **Quota/Limits**
   - Go to: https://console.cloud.google.com/apis/api/firebasevertexai.googleapis.com/quotas?project=coryphaeus-ed11a
   - Check for quota exceeded errors

4. **Backend Type**
   - **Client-side apps:** Use `getAI(app)` (default backend)
   - **Server-side apps:** Use `getAI(app, { backend: new VertexAIBackend() })`

---

## Reference Links

- **Firebase Console - AI Features**: https://console.firebase.google.com/project/coryphaeus-ed11a/genai/
- **Google Cloud APIs**: https://console.cloud.google.com/apis/library/firebasevertexai.googleapis.com?project=coryphaeus-ed11a
- **Firebase AI Documentation**: https://firebase.google.com/docs/ai
- **Gemini API Documentation**: https://ai.google.dev/docs

---

## Commits

| Commit | Description | Date |
|--------|-------------|------|
| `c64076a` | Fix Firebase AI 403 error by switching to default backend | 2025-11-09 |
| `4d3de98` | Add user-friendly error handling for Firebase AI API errors | 2025-11-09 |
| `f08843d` | Add Firebase AI setup and troubleshooting documentation | 2025-11-09 |
| `81dead2` | Add defensive error checks and Phase 3 TODO comments | 2025-11-09 |

---

## Notes

### Key Learnings

- **Root Cause:** The VertexAIBackend was incorrectly used for a client-side web application. This backend is designed for server-side Node.js environments and requires Google Cloud IAM service account credentials.

- **Solution:** The default backend (obtained via `getAI(app)`) is the correct choice for all client-side web applications. It handles authentication through Firebase automatically.

- **Misleading Error Message:** The 403 error message suggested the API wasn't enabled, when in reality the API was enabled but the wrong backend type was being used. This caused confusion during initial troubleshooting.

- **Prevention:** The error handling improvements will help catch similar configuration issues early and provide clearer guidance to users.

- **Documentation:** Firebase AI Logic is relatively new (rebranded from "Vertex AI in Firebase" in May 2025), so documentation and examples may still be evolving. Always verify backend type for your application architecture.

### Resolution Summary

‚úÖ **Issue fully resolved** by switching from VertexAIBackend to default backend
‚úÖ **Tested and confirmed working** with real document analysis
‚úÖ **Error handling improved** for better user experience
‚úÖ **Documentation created** for future reference
