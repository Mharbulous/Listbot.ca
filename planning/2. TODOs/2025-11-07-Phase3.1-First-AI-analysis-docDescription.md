# Phase 3.1: AI Document Description Extraction

**Date**: 2025-11-09
**Phase**: 3.1 (Extension of Phase 3)
**Status**: Planning
**Priority**: Medium

**Context**: Phase 3 successfully implemented AI extraction for DocumentDate and DocumentType. This phase extends the AI analysis to also extract DocumentDescription (the "Description" system category), providing users with AI-generated document summaries.

**Parent Documentation**:
- `2025-11-07-Phase3-First-AI-analysis-dateNtype-display.md` - Phase 3 implementation
- `docs/ai/ai-metadata-extraction-requirements.md` - Overall AI metadata extraction requirements

---

## Phase 3.1 Overview

Extend the existing AI metadata extraction to include DocumentDescription. This provides automatic document summarization alongside the existing date and type extraction.

**Scope**: Add DocumentDescription to the existing AI analysis workflow with minimal changes to architecture.

**What Phase 3 Gave Us**: DocumentDate and DocumentType extraction, display, and storage working end-to-end.

**What Phase 3.1 Adds**: DocumentDescription extraction using the same infrastructure.

**What's Next**: Phase 4 will add human review and editing capabilities for all three fields.

---

## Phase 3.1 Key Changes

### Service Layer Changes
- Update `aiMetadataExtractionService.js` to request description extraction
- Extend AI prompt to include description generation instructions
- Parse and validate description from AI response
- Store description tag using existing `tagSubcollectionService`

### UI Changes
- Add DocumentDescription display to `AIAnalysisTab.vue`
- Show description with same confidence badge pattern
- Include description in the "Analyze Document" analysis
- Display description context/reasoning in tooltip

### No Architecture Changes
- ✅ Same hybrid storage pattern (subcollection + embedded map)
- ✅ Same confidence scoring (≥95% auto-approve)
- ✅ Same batch write pattern via `tagSubcollectionService`
- ✅ Same loading/error handling patterns

---

## Phase 3.1 User Stories

### Story 1: Extract Document Description
**As a** user
**I want to** see an AI-generated summary/description of the document
**So that** I can quickly understand document content without reading the entire file

**Acceptance Criteria**:
- After clicking "Analyze Document", AI extracts description in same API call
- Description is a brief summary (1-3 sentences) of document content
- Description stored in Firestore via `tagSubcollectionService.addTagsBatch()`
- Description persists across browser sessions
- Confidence score displayed with same badge pattern

---

### Story 2: Display Description Results
**As a** user
**I want to** see the description in the AI tab with confidence scoring
**So that** I can assess the quality of the AI-generated summary

**Acceptance Criteria**:
- Description displays in "System Fields" section (after DocumentType)
- Green badge (≥95% confidence) or amber badge (<95%)
- Tooltip shows AI reasoning and context on hover
- Same visual pattern as DocumentDate and DocumentType fields

---

### Story 3: Persist Description Data
**As a** user
**I want** my document descriptions to persist
**So that** I don't lose the AI analysis when I close the browser

**Acceptance Criteria**:
- Description stored in both subcollection and embedded map
- Atomic batch write ensures consistency
- Tag counters update correctly
- Opening AI tab loads existing description from Firestore

---

## Implementation Details

### 1. Update AI Service Prompt

**File**: `src/services/aiMetadataExtractionService.js`

**Current prompt** requests 2 fields (documentDate, documentType).
**New prompt** requests 3 fields (documentDate, documentType, documentDescription).

**Add to `_buildPrompt()` method** (around line 148):

```javascript
_buildPrompt(documentTypes) {
  const typesList = documentTypes.join(', ');

  return `Analyze this document and extract:

1. Document Date: The date the ORIGINAL document was created/signed
   - IGNORE: Payment stamps, received dates, scanned dates, file metadata dates
   - For invoices: Extract invoice date (NOT payment stamp dates like "Paid 2024-12-03")
   - For letters: Extract letter date (NOT received/scanned dates)
   - For contracts: Extract execution/signature date
   - Format: YYYY-MM-DD (ISO 8601)

2. Document Type: Classify from this list ONLY:
   [${typesList}]

3. Document Description: A brief summary of the document (1-3 sentences)
   - Summarize the main purpose, content, or subject matter
   - Include key parties, amounts, or dates if relevant
   - Be concise and factual
   - Examples:
     * "Invoice from Acme Corp for legal services rendered in March 2024, total $5,200"
     * "Employment agreement between John Smith and TechCo dated January 15, 2024"
     * "Internal memo regarding Q4 budget planning and resource allocation"

For each field, provide:
- value: The extracted value
- confidence: 0-100 percentage
- reasoning: Brief explanation
- context: Excerpt from document showing where you found this
- alternatives: suggest 1 alternative (for date/type only, NOT for description)

Return as JSON in this exact format:
{
  "documentDate": {
    "value": "2024-03-15",
    "confidence": 92,
    "reasoning": "Invoice date found in header",
    "context": "Found 'Invoice Date: March 15, 2024' in document header",
    "alternatives": [
      {
        "value": "2024-03-14",
        "confidence": 78,
        "reasoning": "Possible scan date in footer"
      }
    ]
  },
  "documentType": {
    "value": "Invoice",
    "confidence": 98,
    "reasoning": "Document contains 'INVOICE' header, itemized charges",
    "context": "Header: 'INVOICE #12345', line items with prices",
    "alternatives": []
  },
  "documentDescription": {
    "value": "Invoice from Acme Legal Services for consultation and research services, dated March 15, 2024, total amount $2,450.00",
    "confidence": 95,
    "reasoning": "Extracted from header, line items, and total section",
    "context": "Header identifies vendor, line items show services, footer shows total",
    "alternatives": []
  }
}`;
}
```

---

### 2. Update Response Parser

**File**: `src/services/aiMetadataExtractionService.js`

**Update `_parseResponse()` method** (around line 201) to validate description:

```javascript
_parseResponse(text) {
  try {
    // ... existing code for cleaning and parsing JSON ...

    // Validate required fields
    if (!parsed.documentDate || !parsed.documentType || !parsed.documentDescription) {
      throw new Error('Missing required fields in AI response');
    }

    // Validate structure for all three fields
    const validateField = (field, fieldName) => {
      if (!field.value || typeof field.confidence !== 'number') {
        throw new Error(`Invalid ${fieldName} structure in AI response`);
      }
      if (field.confidence < 0 || field.confidence > 100) {
        throw new Error(
          `Invalid confidence value for ${fieldName}: must be 0-100, got ${field.confidence}`
        );
      }
    };

    validateField(parsed.documentDate, 'documentDate');
    validateField(parsed.documentType, 'documentType');
    validateField(parsed.documentDescription, 'documentDescription'); // NEW

    // Validate date format (ISO 8601: YYYY-MM-DD)
    const datePattern = /^\d{4}-\d{2}-\d{2}$/;
    if (parsed.documentDate.value && !datePattern.test(parsed.documentDate.value)) {
      console.warn(
        `Date format validation: expected YYYY-MM-DD, got ${parsed.documentDate.value}`
      );
    }

    // Validate description is a non-empty string
    if (parsed.documentDescription.value && typeof parsed.documentDescription.value !== 'string') {
      console.warn(
        `Description validation: expected string, got ${typeof parsed.documentDescription.value}`
      );
    }

    return parsed;
  } catch (error) {
    console.error('Failed to parse AI response:', error);
    throw new Error(`Invalid AI response format: ${error.message}`);
  }
}
```

---

### 3. Update AIAnalysisTab Component

**File**: `src/components/document/tabs/AIAnalysisTab.vue`

#### 3.1 Add Description to State

**Update reactive state** (around line 222):

```javascript
const aiResults = ref({
  documentDate: null,
  documentType: null,
  documentDescription: null, // NEW
});

const fieldPreferences = ref({
  documentDate: 'analyze',
  documentType: 'analyze',
  documentDescription: 'analyze', // NEW
});
```

#### 3.2 Update loadAITags()

**Update `loadAITags()` method** (around line 310):

```javascript
aiResults.value = {
  documentDate: tags?.find(t => t?.categoryId === 'DocumentDate') || null,
  documentType: tags?.find(t => t?.categoryId === 'DocumentType') || null,
  documentDescription: tags?.find(t => t?.categoryId === 'Description') || null, // NEW
};
```

**Note**: System category ID is `Description`, not `DocumentDescription`.

#### 3.3 Store Description in Firestore

**Update `handleAnalyzeClick()` method** (around line 465):

Add description storage after documentType:

```javascript
if (result.documentDescription) {
  tagsToStore.push({
    categoryId: 'Description', // System category ID
    categoryName: 'Description', // System category name
    tagName: result.documentDescription.value,
    confidence: result.documentDescription.confidence,
    source: 'ai',
    autoApproved: result.documentDescription.confidence >= confidenceThreshold,
    reviewRequired: result.documentDescription.confidence < confidenceThreshold,
    createdBy: authStore.user?.uid || 'system',
    metadata: {
      model: 'gemini-2.5-flash-lite',
      processingTime: result.processingTime,
      aiReasoning: result.documentDescription.reasoning,
      context: result.documentDescription.context,
      aiAlternatives: result.documentDescription.alternatives || [],
      reviewReason: result.documentDescription.confidence < confidenceThreshold
        ? 'Confidence below threshold'
        : null
    }
  });
}
```

#### 3.4 Add Description Display to Template

**Add to template** after DocumentType field (around line 186):

```vue
<!-- Document Description -->
<div class="metadata-item">
  <span class="metadata-label">Document Description:</span>

  <div class="field-controls">
    <!-- Radio Button Group -->
    <v-radio-group
      v-model="fieldPreferences.documentDescription"
      inline
      hide-details
      class="field-radio-group"
    >
      <v-radio label="Analyze" value="analyze" color="primary"></v-radio>
      <v-radio label="Skip" value="skip" color="primary"></v-radio>
      <v-radio label="Ignore" value="ignore" color="primary"></v-radio>
    </v-radio-group>

    <!-- State 2: Analyzing Spinner -->
    <div v-if="isAnalyzing" class="analyzing-state">
      <v-progress-circular indeterminate size="20" color="primary" />
      <span class="analyzing-text">Analyzing...</span>
    </div>

    <!-- State 3: AI Result with Tooltip -->
    <div v-else-if="aiResults.documentDescription" class="ai-result">
      <v-tooltip location="bottom" max-width="500">
        <template v-slot:activator="{ props: tooltipProps }">
          <div v-bind="tooltipProps" class="ai-result-content">
            <span class="ai-result-value description-text">
              {{ aiResults.documentDescription.tagName }}
            </span>
            <v-chip
              :color="getConfidenceBadgeColor(aiResults.documentDescription.confidence)"
              size="small"
              variant="flat"
              class="ai-result-badge"
            >
              {{ aiResults.documentDescription.confidence }}%
            </v-chip>
          </div>
        </template>

        <!-- Tooltip Content -->
        <div class="ai-tooltip-content">
          <div v-if="aiResults.documentDescription.metadata?.context" class="ai-tooltip-section">
            <strong>Context:</strong>
            <p>{{ aiResults.documentDescription.metadata.context }}</p>
          </div>
          <div v-if="aiResults.documentDescription.metadata?.aiReasoning" class="ai-tooltip-section">
            <strong>Reasoning:</strong>
            <p>{{ aiResults.documentDescription.metadata.aiReasoning }}</p>
          </div>
        </div>
      </v-tooltip>
    </div>
  </div>
</div>
```

#### 3.5 Add Description Styling

**Add to `<style scoped>` section**:

```css
/* Description text - allow wrapping for longer text */
.description-text {
  white-space: normal;
  line-height: 1.4;
  max-width: 600px;
}
```

---

## Success Criteria

### Functional
- **F1**: Opening AI tab loads existing Description tag from Firestore (if exists)
- **F2**: Clicking "Analyze Document" extracts all three fields in single API call
- **F3**: Description displays with confidence badge
- **F4**: Description stores in Firestore via batch write
- **F5**: Description persists across browser sessions

### Storage
- **S1**: Description stored in subcollection at `tags/Description`
- **S2**: Description embedded in evidence document at `evidence.tags.Description`
- **S3**: Both writes happen atomically (batch operation)
- **S4**: Tag counters update correctly (tagCount, autoApprovedCount, reviewRequiredCount)

### UI/UX
- **U1**: Description displays after DocumentType in System Fields section
- **U2**: Confidence badge color-coded correctly (≥95% green, <95% amber)
- **U3**: Tooltip shows reasoning and context
- **U4**: Same visual pattern as other fields (consistency)
- **U5**: Text wraps properly for longer descriptions

---

## Testing Plan

### Manual Test Cases

#### TC1: First Analysis with Description
**Steps**:
1. Open AI tab for never-analyzed document
2. Click "Analyze Document"
3. Wait for analysis to complete
4. Verify all three fields display (Date, Type, Description)

**Expected**:
- Description displays with appropriate text
- Confidence badge shows percentage
- Tooltip shows context and reasoning
- All three tags stored in Firestore

---

#### TC2: Load Existing Description
**Setup**: Document already analyzed with description
**Steps**:
1. Open AI tab
2. Observe loaded data

**Expected**:
- Description loads immediately (no button)
- Same text and confidence as previously stored
- No re-analysis triggered

---

#### TC3: High Confidence Description
**File**: Clear, standard document (invoice, letter, etc.)
**Expected**:
- Green badge (≥95%)
- Firestore: `autoApproved: true`, `reviewRequired: false`
- Concise, accurate description

---

#### TC4: Low Confidence Description
**File**: Complex or ambiguous document
**Expected**:
- Amber/red badge (<95%)
- Firestore: `reviewRequired: true`
- Description still shown (best attempt)
- Ready for Phase 4 review workflow

---

#### TC5: Description Quality Check
**Files**: Test various document types
- Invoice: Should mention vendor, amount, date
- Letter: Should mention sender, recipient, subject
- Contract: Should mention parties, type of agreement
- Email: Should mention sender, recipient, topic

**Expected**:
- Descriptions are factual and relevant
- Key information included (parties, amounts, dates)
- 1-3 sentence length maintained
- Professional tone

---

## Implementation Checklist

- [ ] Update `_buildPrompt()` in `aiMetadataExtractionService.js`
  - Add documentDescription section to prompt
  - Include examples and guidelines
  - Specify 1-3 sentence length

- [ ] Update `_parseResponse()` in `aiMetadataExtractionService.js`
  - Add documentDescription to required fields check
  - Add validation for description field
  - Validate description is non-empty string

- [ ] Update `AIAnalysisTab.vue` state
  - Add `documentDescription: null` to `aiResults`
  - Add `documentDescription: 'analyze'` to `fieldPreferences`

- [ ] Update `loadAITags()` in `AIAnalysisTab.vue`
  - Add Description to tags query
  - Map to `aiResults.documentDescription`

- [ ] Update `handleAnalyzeClick()` in `AIAnalysisTab.vue`
  - Add description to `tagsToStore` array
  - Use correct categoryId: 'Description'
  - Include all metadata fields

- [ ] Add description display to template
  - Add metadata-item for Document Description
  - Add radio button group
  - Add analyzing state
  - Add result display with tooltip
  - Add styling for description text wrapping

- [ ] Test end-to-end workflow
  - Test first analysis
  - Test loading existing tags
  - Test high/low confidence scenarios
  - Test various document types
  - Verify Firestore storage (both locations)

- [ ] Update documentation
  - Update AI metadata extraction requirements doc
  - Add Phase 3.1 notes to aiAnalysis.md

---

## Notes

### System Category Name
- **CategoryId**: `Description` (NOT `DocumentDescription`)
- **CategoryName**: `Description`
- **Type**: Text Area
- This is an existing system category, already defined in Firestore

### Prompt Engineering Considerations
- Description should be factual, not interpretive
- Include key information (parties, amounts, dates) when present
- Avoid subjective language or opinions
- 1-3 sentences is a guideline, not a hard limit
- AI should extract, not generate creative content

### Confidence Scoring for Descriptions
- Unlike date/type which have clear "correct" answers, descriptions are subjective
- Confidence should reflect:
  - Clarity of document content
  - Completeness of extracted information
  - Presence of ambiguity or missing context
- Expected: Most descriptions will have moderate-to-high confidence (70-95%)

### Alternatives for Description
- Unlike date/type, descriptions don't need "alternatives"
- There's no "wrong" description, just varying levels of completeness
- Prompt should NOT request alternatives for description field
- This simplifies the response structure

### Review Workflow (Phase 4)
- Description review will focus on:
  - Accuracy of facts mentioned
  - Completeness (missing key information?)
  - Clarity and conciseness
- Users can edit description as free text (Text Area field)
- No alternative suggestions needed

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Descriptions too long or verbose | Medium | Clear 1-3 sentence guideline in prompt, examples |
| Descriptions too vague or generic | Medium | Prompt emphasizes key information (parties, amounts, dates) |
| Hallucination (AI inventing facts) | High | Prompt emphasizes factual extraction only, confidence scoring |
| Description quality varies by document type | Low | Provide document-type-specific examples in prompt |
| Token costs increase (longer responses) | Low | Descriptions are brief, marginal cost increase acceptable |

---

## Phase 3.1 vs Phase 3 Comparison

### Phase 3 (Complete)
- Extracted: DocumentDate, DocumentType
- Fields: 2
- Prompt complexity: Medium
- Response parsing: 2 fields
- UI sections: 2 metadata items
- Review complexity: Binary (correct/incorrect)

### Phase 3.1 (This Phase)
- Extracted: DocumentDate, DocumentType, **DocumentDescription**
- Fields: 3 (+1)
- Prompt complexity: Medium (+description guidelines)
- Response parsing: 3 fields (+1)
- UI sections: 3 metadata items (+1)
- Review complexity: Mixed (binary for date/type, editorial for description)

### Changes Required
- Service: 1 file (`aiMetadataExtractionService.js`) - 2 methods
- Component: 1 file (`AIAnalysisTab.vue`) - template + script
- Estimated effort: 4-6 hours
- Testing effort: 2-3 hours

---

## Future Enhancements (Out of Scope)

1. **Smart Description Length**: Vary description length based on document complexity
2. **Entity Extraction**: Extract and highlight key entities (people, companies, amounts)
3. **Multi-Language Descriptions**: Generate descriptions in user's preferred language
4. **Description Templates**: Pre-fill descriptions based on document type templates
5. **Description History**: Track description changes over time
6. **Semantic Search**: Use descriptions for better document search

---

## Completion Checklist

When Phase 3.1 is complete, all items should be checked:

- [ ] Prompt updated to request documentDescription
- [ ] Response parser validates documentDescription
- [ ] AI service returns all three fields
- [ ] AIAnalysisTab state includes documentDescription
- [ ] loadAITags() loads Description tag
- [ ] handleAnalyzeClick() stores Description tag
- [ ] Template displays description field
- [ ] Description styling added (text wrapping)
- [ ] TC1-TC5 manual tests pass
- [ ] Firestore storage verified (subcollection + embedded)
- [ ] Tag counters update correctly
- [ ] Results persist across sessions
- [ ] Ready for Phase 4 (review workflow)

---

**Document Version**: 1.0
**Last Updated**: 2025-11-09
**Status**: Planning → Ready for Implementation

---

## Cross-References

- **Parent Phase**: `2025-11-07-Phase3-First-AI-analysis-dateNtype-display.md`
- **Requirements**: `docs/ai/ai-metadata-extraction-requirements.md`
- **Service**: `src/services/aiMetadataExtractionService.js`
- **Component**: `src/components/document/tabs/AIAnalysisTab.vue`
- **System Categories**: `docs/front-end/DocumentTable.md` (lines 38-52)
