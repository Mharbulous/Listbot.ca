# Phase 1.5: Firebase AI Setup & Troubleshooting

**Status:** In Progress
**Date Started:** 2025-11-07
**Last Updated:** 2025-11-09
**Related Phase:** Phase 2 - AI Document Analysis

---

## Overview

This document tracks the setup and troubleshooting of Firebase AI Logic (Vertex AI in Firebase) integration for AI-powered metadata extraction in the Bookkeeper app.

---

## Problem Statement

After implementing Phase 2 AI document analysis, users encountered **403 Forbidden** errors when attempting to use the AI analysis features. The error message indicated that the Firebase AI API was not enabled, despite the API being enabled in the Firebase Console.

### Initial Error

```
POST https://firebasevertexai.googleapis.com/v1beta/projects/coryphaeus-ed11a/locations/us-central1/publishers/google/models/gemini-2.5-flash-lite:generateContent 403 (Forbidden)

FirebaseError: AI: The Firebase AI SDK requires the Firebase AI API ('firebasevertexai.googleapis.com') to be enabled in your Firebase project.
```

---

## Investigation & Solutions Attempted

### ✅ Solution 1: Verified Firebase AI API is Enabled

**Action Taken:**
- Checked Firebase Console at: https://console.firebase.google.com/project/coryphaeus-ed11a/genai/
- Verified "Get Started" button was already clicked
- Confirmed API is enabled in Google Cloud Console

**Result:**
- API was already enabled
- This was NOT the root cause

---

### ✅ Solution 2: Verified Billing Configuration

**Action Taken:**
- Confirmed project is on Blaze (pay-as-you-go) plan
- Verified billing account is linked

**Result:**
- Billing is properly configured
- This was NOT the root cause

---

### ✅ Solution 3: Fixed Backend Type (ROOT CAUSE FOUND)

**Problem Identified:**
The code was using `VertexAIBackend`, which is designed for **server-side Node.js applications** and requires:
- Google Cloud IAM service account credentials
- Server-side authentication
- Additional permissions configuration

The Bookkeeper app is a **client-side web application** and needs the default backend.

**Action Taken:**
Changed `src/services/firebase.js` from:
```javascript
import { getAI, VertexAIBackend } from 'firebase/ai';
// ...
firebaseAI = getAI(app, { backend: new VertexAIBackend() });
```

To:
```javascript
import { getAI } from 'firebase/ai';
// ...
firebaseAI = getAI(app); // Uses default backend for client-side apps
```

**Result:**
- Code change committed: `c64076a`
- Awaiting testing to confirm fix

---

### ✅ Solution 4: Improved Error Handling

**Action Taken:**
Enhanced `DocumentMetadataPanel.vue` to provide user-friendly error messages:

**Features Added:**
- `aiError` reactive state for tracking errors
- Error detection and categorization:
  - API not enabled
  - File too large
  - Unknown/general errors
- User-friendly error alert UI with:
  - Clear error titles and messages
  - Actionable next steps
  - Direct links to Firebase Console
  - Dismissable alerts

**Result:**
- Code change committed: `4d3de98`
- Users now see helpful error messages instead of just console errors
- Provides clear guidance for resolving configuration issues

---

## Problems Eliminated (Not the Cause)

1. ❌ Firebase AI API not enabled → API was already enabled
2. ❌ Billing not configured → Blaze plan active with billing linked
3. ❌ API propagation delay → API has been enabled for days/weeks
4. ❌ Missing environment variables → All Firebase env vars are set correctly

---

## Current Status

### Completed
- [x] Identified root cause: Wrong backend type (VertexAIBackend vs default)
- [x] Fixed Firebase AI initialization to use default backend
- [x] Added comprehensive error handling and user feedback
- [x] Committed and pushed changes to branch `claude/fix-console-errors-011CUv6mYej11mSReXGDp3Xp`
- [x] Created troubleshooting documentation

### Pending
- [ ] User restart dev server to pick up changes
- [ ] Test AI analysis with "Analyze Document" button
- [ ] Verify 403 errors are resolved
- [ ] Confirm Gemini API calls succeed
- [ ] Test with various file types and sizes

---

## Technical Details

### Backend Types in Firebase AI SDK

**VertexAIBackend** (Server-side)
- For Node.js server applications
- Requires service account credentials
- Needs Google Cloud IAM permissions
- Direct access to Vertex AI API

**Default Backend** (Client-side)
- For web applications running in browser
- Uses Firebase authentication automatically
- Works with Firebase API keys
- No additional IAM setup required

### Files Modified

1. **src/services/firebase.js**
   - Removed `VertexAIBackend` import and usage
   - Changed to default backend: `getAI(app)`
   - Updated comments to clarify backend usage

2. **src/components/document/DocumentMetadataPanel.vue**
   - Added `aiError` state tracking
   - Enhanced `handleAnalyzeClick` with error detection
   - Added error alert UI component
   - Added CSS styling for error display

---

## Next Steps

### Immediate Testing (User Action Required)

1. **Restart Dev Server**
   ```bash
   npm run dev
   ```

2. **Test AI Analysis**
   - Navigate to a document in the app
   - Click the "AI" tab in the metadata panel
   - Click "Analyze Document" button
   - Observe results

3. **Expected Outcomes**
   - ✅ Success: Gemini API call completes, document analysis works
   - ❌ Still fails: See new error message in UI and check "Further Troubleshooting" section

### Further Troubleshooting (If Still Failing)

If the 403 error persists after switching to default backend:

1. **Check API Key Restrictions**
   - Go to: https://console.cloud.google.com/apis/credentials?project=coryphaeus-ed11a
   - Find your Firebase API key
   - Check if there are restrictions preventing Vertex AI API calls
   - May need to add `firebasevertexai.googleapis.com` to allowed APIs

2. **Verify User Authentication**
   - Ensure user is properly authenticated in Firebase Auth
   - Check `authStore.isAuthenticated` and `authStore.currentFirm`
   - Vertex AI may require authenticated users

3. **Check Quota/Limits**
   - Go to: https://console.cloud.google.com/apis/api/firebasevertexai.googleapis.com/quotas?project=coryphaeus-ed11a
   - Verify no quota exceeded errors
   - Check daily/monthly limits

4. **Enable Additional APIs (if needed)**
   - Vertex AI API: https://console.cloud.google.com/apis/library/aiplatform.googleapis.com?project=coryphaeus-ed11a
   - Generative Language API: https://console.cloud.google.com/apis/library/generativelanguage.googleapis.com?project=coryphaeus-ed11a

---

## Reference Links

- **Firebase Console - AI Features**: https://console.firebase.google.com/project/coryphaeus-ed11a/genai/
- **Google Cloud APIs**: https://console.cloud.google.com/apis/library/firebasevertexai.googleapis.com?project=coryphaeus-ed11a
- **Firebase AI Documentation**: https://firebase.google.com/docs/ai
- **Gemini API Documentation**: https://ai.google.dev/docs

---

## Commits

| Commit | Description | Date |
|--------|-------------|------|
| `c64076a` | Fix Firebase AI 403 error by switching to default backend | 2025-11-09 |
| `4d3de98` | Add user-friendly error handling for Firebase AI API errors | 2025-11-09 |

---

## Notes

- The VertexAIBackend was likely chosen based on outdated documentation or a misunderstanding of the backend types
- The default backend is the correct choice for all client-side web applications
- Error handling improvements will help catch any future configuration issues early
- Firebase AI Logic is relatively new (rebranded May 2025), so documentation may still be evolving
